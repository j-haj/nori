context_version: 1
module: architecture
layering:
  - domain: "types, ids, versions, errors; no I/O"
  - ports: "Storage, ReplicatedLog, Membership, Placement, Transport, Router"
  - adapters: "LSM (WAL+SST), Raft, SWIM gossip, gRPC, HTTP"
  - composition: "server node wires components via DI"
workspace_crates:
  public_libs:
    - name: nori-observe
      purpose: "Vendor-neutral observability ABI: Meter traits + VizEvent enums + macros."
    - name: nori-wal
      purpose: "Append-only write-ahead log with recovery and rotation."
    - name: nori-sstable
      purpose: "Immutable sorted tables with blocks, index, bloom, compression."
    - name: nori-lsm
      purpose: "Embeddable LSM engine (WAL+SST+compaction+snapshots). Implements Storage."
    - name: nori-swim
      purpose: "SWIM-like membership/failure detector with events."
    - name: nori-raft
      purpose: "Raft core: consensus, read-index, leases, snapshots, joint reconfig."
  internal_crates:
    - name: norikv-types
      purpose: "IDs, error codes, small enums shared internally."
      publish: false
    - name: norikv-placement
      purpose: "Shard/replica planning with Jump Consistent Hash; minimal-move diffs."
      publish: false
    - name: norikv-transport-grpc
      purpose: "Tonic-based gRPC + tiny HTTP faÃ§ade."
      publish: false
    - name: norikv-server
      purpose: "Node binary; composition, config, health, auth, metrics, admin."
      publish: false
    - name: norikv-cli
      purpose: "Admin/bench tools."
      publish: false
    - name: norikv-testkit
      purpose: "Chaos simulator, linearizability checker, deterministic net/disk faults."
      publish: false
    - name: nori-observe-prom
      purpose: "Prometheus/OpenMetrics exporter implementing Meter."
      publish: optional
    - name: nori-observe-otlp
      purpose: "OTLP gRPC exporter implementing Meter (+ traces exemplars)."
      publish: optional
    - name: norikv-vizd
      purpose: "Event aggregator + WS/gRPC-web stream for dashboard."
      publish: false
    - name: norikv-dashboard
      purpose: "Next.js/React animated UI."
      publish: false
stable_ports:
  storage_trait: "See 30_storage.yaml"
  replicated_log_trait: "See 31_consensus.yaml"
  membership_trait: "See 32_membership.yaml"
  placement_trait: "See 33_placement.yaml"
  transport_trait: "See 34_transport.yaml"
  router_trait: "trait Router { fn shard_of(&self, key_hash: u64) -> ShardId; fn route(&self, shard: ShardId) -> Option<NodeId>; }"
recommended_defaults:
  replication_factor: 3
  total_virtual_shards: 1024
  key_hash: "xxhash64(seed=0)"
  consistent_hash: "jump_consistent_hash"
