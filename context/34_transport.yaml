context_version: 1
module: transport
goals:
  - gRPC as primary; tiny HTTP/JSON façade
  - Idempotency and retries; explicit read consistency
endpoints:
  grpc_services:
    Kv:
      - "Put(key, value, ttl?, idempotency_key?, if_match_version?) -> (version, metadata)"
      - "Get(key, read_consistency=lease|linearizable|stale_ok) -> (value?, version, metadata)"
      - "Delete(key, if_match_version?, idempotency_key?) -> (tombstoned)"
    Meta:
      - "WatchCluster(epoch?) -> stream ClusterView"
    Admin:
      - "TransferShard(shard_id, to_node)"
      - "SnapshotShard(shard_id)"
  http_facade:
    - "PUT /kv/{key}"
    - "GET /kv/{key}?consistency=lease|linearizable|stale_ok"
    - "DELETE /kv/{key}"
    - "GET /meta/cluster"
errors:
  - code: NOT_LEADER
    client_behavior: "refresh leader; backoff 10–100ms jitter"
  - code: QUORUM_UNAVAILABLE
    client_behavior: "surface 503; do not spin"
  - code: COMMIT_TIMEOUT
    client_behavior: "retry idempotent ops only"
security:
  mtls: optional dev, required prod
  auth: "interceptor hooks; token or mTLS identities"
